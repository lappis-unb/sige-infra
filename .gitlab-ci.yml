image:
  name: hashicorp/terraform
  entrypoint: ['']

variables:
  TF_ROOT: ${CI_PROJECT_DIR}/terraform

cache:
  key: '${CI_COMMIT_REF_SLUG}'
  paths:
    - ${TF_ROOT}/.terraform/

stages:
  - setup
  - plan
  - apply
  - destroy

before_script:
  - terraform --version
  - cd ${TF_ROOT}

format:
  stage: setup
  script:
    - terraform fmt
  cache: []
  allow_failure: true

init:
  stage: setup
  script:
    - terraform init

validate:
  stage: setup
  script:
    - terraform validate
  allow_failure: true

apply_infra:
  stage: apply
  script:
    - export TF_VAR_do_token=${DIGITALOCEAN_ACCESS_TOKEN}
    - export TF_VAR_ssh_key=${PUBLIC_SSH_KEY}
    - terraform apply -auto-approve
  artifacts:
    name: '$CI_JOB_NAME'
    paths:
      - ./hosts
    expire_in: 6 hours
  when: manual

destroy_infra:
  stage: destroy
  script:
    - export TF_VAR_do_token=${DIGITALOCEAN_ACCESS_TOKEN}
    - terraform destroy -auto-approve
  when: manual
